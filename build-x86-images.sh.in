#!/bin/sh

ARCH=
IMAGE=

while getopts "a:b:hr:" opt; do
case $opt in
	a) ARCH="$OPTARG";;
	b) IMAGE="$OPTARG";;
	h) echo "${0#/*}: [-a arch] [-b base | xfce | cinnamon | plasma | lxqt ] [-r repo]" >&2; exit 1;;
	r) REPO="-r $OPTARG $REPO";;
esac
done
shift $((OPTIND - 1))

: ${ARCH:=$(uname -m)}

readonly CEREUS_INCLUDEDIR="$PWD/includedir"
readonly REPO_CORE=https://sourceforge.net/projects/cereus-linux/files/repos/cereus-core/${ARCH}
readonly REPO_EXTRA=https://sourceforge.net/projects/cereus-linux/files/repos/cereus-extra/${ARCH}

readonly DATE=$(date +%Y%m%d)
readonly BASE_IMG=cereus-live-${ARCH}-${DATE}.iso
readonly XFCE_IMG=cereus-live-${ARCH}-${DATE}-xfce.iso
readonly CINNAMON_IMG=cereus-live-${ARCH}-${DATE}-cinnamon.iso
readonly PLASMA_IMG=cereus-live-${ARCH}-${DATE}-plasma.iso
readonly LXQT_IMG=cereus-live-${ARCH}-${DATE}-lxqt.iso

readonly GRUB="grub-i386-efi grub-x86_64-efi"

readonly BASE_PKGS="dialog cryptsetup lvm2 mdadm void-docs-browse calamares nano rsync zstd cereus-repo-core cereus-repo-extra chrony $GRUB"
readonly X_PKGS="$BASE_PKGS xorg-minimal xorg-input-drivers xorg-video-drivers setxkbmap xauth font-misc-misc terminus-font dejavu-fonts-ttf alsa-plugins-pulseaudio"

GLIBC_PKGS=""
REPO_MULTILIB=""
REPO_MULTILIB_NONFREE=""

case ${ARCH} in
    x86_64)
        GLIBC_PKGS="void-repo-multilib"
        REPO_NONFREE="https://alpha.de.repo.voidlinux.org/current/nonfree"
        REPO_MULTILIB="https://alpha.de.repo.voidlinux.org/current/multilib"
        REPO_MULTILIB_NONFREE="https://alpha.de.repo.voidlinux.org/current/multilib/nonfree"
        sed -i 's/musl/libc/g' ${CEREUS_INCLUDEDIR}/*/etc/calamares/modules/locale.conf 
;;
    *-musl)
        REPO_NONFREE="https://alpha.de.repo.voidlinux.org/current/musl/nonfree"
        sed -i 's/libc/musl/g' ${CEREUS_INCLUDEDIR}/*/etc/calamares/modules/locale.conf;;
    i686)
        REPO_NONFREE="https://alpha.de.repo.voidlinux.org/current/nonfree"
        sed -i 's/musl/libc/g' ${CEREUS_INCLUDEDIR}/*/etc/calamares/modules/locale.conf  ;;
esac

readonly THEMES_PKGS="Graphite-kvantum-theme-black graphite-gtk-theme-black flat-remix-icon-theme-green Graphite-color-schemes-black"

readonly CEREUS_BASEPKGS="$GLIBC_PKGS lightdm lightdm-gtk3-greeter lightdm-gtk-greeter-settings simple-scan cereus-neofetch cereus-wallpapers htop octoxbps nano void-repo-nonfree accountsservice blesh bluez fonts-roboto-ttf gparted gst-libav gst-plugins-base1 gst-plugins-good1 hplip-gui htop jetbrains-mono-font ksuperkey kvantum libcups-filters mpv mypaint nerd-fonts-symbols octoxbps pulseaudio python3-cups python3-cupshelpers system-config-printer system-config-printer-udev vpm vsv xtools numlockx broadcom-wl-dkms musl-locales"

readonly XFCE_PKGS="$X_PKGS xfce4 gnome-themes-standard gnome-keyring network-manager-applet gvfs-afc gvfs-mtp gvfs-smb udisks2 xfce4-whiskermenu-plugin xfce4-pulseaudio-plugin xfce4-clipman-plugin"
readonly CINNAMON_PKGS="$X_PKGS lxdm cinnamon gnome-keyring colord tilix gvfs-afc gvfs-mtp gvfs-smb udisks2 firefox"
readonly PLASMA_PKGS="$X_PKGS kde5 konsole firefox dolphin sddm konsole"
readonly LXQT_PKGS="$X_PKGS $THEMES_PKGS $CEREUS_BASEPKGS lxqt gvfs-afc gvfs-mtp gvfs-smb udisks2 lightdm lightdm-gtk3-greeter lightdm-gtk-greeter-settings CopyQ betterlockscreen blueman clementine flameshot midori galculator-gtk3 qpdfview xed-xapps xidlehook xcompmgr network-manager-applet"

[ ! -x mklive.sh ] && exit 0

if [ -z "$IMAGE" -o "$IMAGE" = base ]; then
	if [ ! -e $BASE_IMG ]; then
		./mklive.sh -a $ARCH -o $BASE_IMG -I "$CEREUS_INCLUDEDIR/base" -p "$BASE_PKGS" ${REPO} -r ${REPO_CORE} -r ${REPO_EXTRA} -r ${REPO_NONFREE} -r ${REPO_MULTILIB} -r ${REPO_MULTILIB_NONFREE} -T "Cereus Linux Base" "$@"
	fi
fi
if [ -z "$IMAGE" -o "$IMAGE" = xfce ]; then
	if [ ! -e $XFCE_IMG ]; then
		./mklive.sh -a $ARCH -o $XFCE_IMG -I "$CEREUS_INCLUDEDIR/xfce" -p "$XFCE_PKGS" ${REPO} -r ${REPO_CORE} -r ${REPO_EXTRA} -r ${REPO_NONFREE} -r ${REPO_MULTILIB} -r ${REPO_MULTILIB_NONFREE} -T "Cereus Linux XFCE" "$@"
	fi
fi
if [ -z "$IMAGE" -o "$IMAGE" = cinnamon ]; then
	if [ ! -e $CINNAMON_IMG ]; then
		./mklive.sh -a $ARCH -o $CINNAMON_IMG -I "$CEREUS_INCLUDEDIR/cinnamon" -p "$CINNAMON_PKGS" ${REPO} -r ${REPO_CORE} -r ${REPO_EXTRA}  -r ${REPO_NONFREE} -r ${REPO_MULTILIB} -r ${REPO_MULTILIB_NONFREE} -T "Cereus Linux Cinnamon" "$@"
	fi
fi
if [ -z "$IMAGE" -o "$IMAGE" = lxqt ]; then
	if [ ! -e $LXQT_IMG ]; then
		./mklive.sh -a $ARCH -o $LXQT_IMG -I "$CEREUS_INCLUDEDIR/lxqt/" -p "$LXQT_PKGS" ${REPO} -r ${REPO_CORE} -r ${REPO_EXTRA} -r ${REPO_NONFREE} -r ${REPO_MULTILIB} -r ${REPO_MULTILIB_NONFREE} -T "Cereus Linux LXQt" "$@"
	fi
fi
if [ -z "$IMAGE" -o "$IMAGE" = plasma ]; then
	if [ ! -e $PLASMA_IMG ]; then
		./mklive.sh -a $ARCH -o $PLASMA_IMG -I "$CEREUS_INCLUDEDIR/plasma" -p "$PLASMA_PKGS" ${REPO} -r ${REPO_CORE} -r ${REPO_EXTRA} -r ${REPO_NONFREE} -r ${REPO_MULTILIB} -r ${REPO_MULTILIB_NONFREE} -T "Cereus Linux Plasma" "$@"
	fi
fi
