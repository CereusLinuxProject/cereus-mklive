#!/bin/sh

set -eu

ARCH=$(uname -m)
IMAGES="base xfce cinnamon plasma lxqt fluxbox i3wm lxde"
REPO=
ARCH_PKGS=
REPO_MULTILIB=
REPO_MULTILIB_NONFREE=
SU_PKG=sudo
DATE=$(date +%Y.%m.%d)

help() {
    echo "${0#/*}: [-a arch] [-b base | xfce | cinnamon | plasma | lxqt | fluxbox | i3wm | lxde ] [-r repo] [-s sudo | doas ]" >&2
}

while getopts "a:b:hr:s:" opt; do
case $opt in
	a) ARCH="$OPTARG";;
	b) IMAGES="$OPTARG";;
    h) help; exit 0;;
    r) REPO="-r $OPTARG $REPO";;
    s) SU_PKG="$OPTARG";;
    *) help; exit 1;;
esac
done
shift $((OPTIND - 1))

case $SU_PKG in
    sudo) SU_PKG="sudo";;
    doas) SU_PKG="opendoas";;
    *) echo "SU_PKG: Invalid option $SU_PKG"; exit 1;;
esac

build_variant() {
    variant="$1"
    CEREUS_INCLUDEDIR="$PWD/includedir"
    IMG=cereus-live-${ARCH}-${variant}-${SU_PKG}-${DATE}.iso
    GRUB_PKGS="grub-i386-efi grub-x86_64-efi"
    ARCH_PKGS=""
    PKGS="dialog cryptsetup lvm2 mdadm void-docs-browse nano rsync zstd cereus-repo-core cereus-repo-extra chrony xtools-minimal $SU_PKG $GRUB_PKGS"
    XORG_PKGS="xorg-minimal xorg-input-drivers xorg-video-drivers-cereus setxkbmap xauth font-misc-misc terminus-font dejavu-fonts-ttf alsa-pipewire pipewire gstreamer1-pipewire wireplumber pipewire-doc pulseaudio-utils"

# Declare base repositories url
    VOID_REPO="https://repo-default.voidlinux.org/current"
    CEREUS_REPO="https://sourceforge.net/projects/cereus-linux/files/repos"
    REPO_EXTRA="${CEREUS_REPO}/cereus-extra/${ARCH}"
    REPO_CORE="${CEREUS_REPO}/cereus-core/${ARCH}"

# Default common themes among all editions
    THEMES_PKGS="Graphite-kvantum-theme-black Graphite-gtk-theme-black Tela-icon-theme-green Graphite-color-schemes-black Graphite-cursors"

# Default common base packages among all editions, except the base one.
    CEREUS_BASEPKGS="$ARCH_PKGS calamares-cereus elogind simple-scan cereus-neofetch htop nano void-repo-nonfree accountsservice blesh bluez fonts-roboto-ttf gparted gst-libav gst-plugins-base1 gst-plugins-good1 hplip-gui htop jetbrains-mono-font ksuperkey kvantum libcups-filters mpv mypaint nerd-fonts-symbols octoxbps-git python3-cups python3-cupshelpers system-config-printer system-config-printer-udev vpm vsv xtools numlockx broadcom-wl-dkms xdg-user-dirs hardinfo timeshift psmisc breeze ntfs-3g touchegg touchegg-gce xz unrar unzip zip plymouth cereus-plymouth-theme libva-utils sof-firmware libspa-bluetooth connman-ui connman-gtk connman-ncurses falkon"

# Change locale.conf for calamares depending on target libc and set specific arch pkgs
case ${ARCH} in
    x86_64)
        ARCH_PKGS="void-repo-multilib"
        REPO_NONFREE="${VOID_REPO}/nonfree"
        REPO_MULTILIB="${VOID_REPO}/multilib"
        REPO_MULTILIB_NONFREE="${VOID_REPO}/multilib/nonfree"
        sed -i 's/musl/libc/g' ${CEREUS_INCLUDEDIR}/*/etc/calamares/modules/locale.conf;;
    *-musl)
        REPO_NONFREE="${VOID_REPO}/musl/nonfree"
        sed -i 's/libc/musl/g' ${CEREUS_INCLUDEDIR}/*/etc/calamares/modules/locale.conf;;
    i686)
        REPO_NONFREE="${VOID_REPO}/nonfree"
        sed -i 's/musl/libc/g' ${CEREUS_INCLUDEDIR}/*/etc/calamares/modules/locale.conf;;
esac

    case $variant in
        base) ;;
        xfce)
            PKGS="$PKGS $XORG_PKGS $THEMES_PKGS $ARCH_PKGS $CEREUS_BASEPKGS lightdm lightdm-gtk3-greeter lightdm-gtk-greeter-settings xfce4 gnome-themes-standard gnome-keyring gvfs-afc gvfs-mtp gvfs-smb udisks2 xfce4-whiskermenu-plugin xfce4-pulseaudio-plugin xfce4-clipman-plugin thunar-archive-plugin evince xarchiver blueman rhythmbox xfce4-screenshooter xfce4-plugins galculator-gtk3 material-black-cereus-xfwm qt5ct xfce4-docklike-plugin mugshot"
        ;;
        cinnamon)
            PKGS="$PKGS $XORG_PKGS $THEMES_PKGS $ARCH_PKGS $CEREUS_BASEPKGS lightdm lightdm-gtk3-greeter lightdm-gtk-greeter-settings cinnamon gnome-keyring colord tilix gvfs-afc gvfs-mtp gvfs-smb udisks2 blueman eog gnome-screenshot qt5ct rhythmbox xed-xapps xdg-user-dirs evince galculator-gtk3 nemo{,-emblems,-extensions,-fileroller,-image-converter,-preview,-python,-terminal,compare,audio-tab} clipit xviewer"
        ;;
        plasma)
            PKGS="$PKGS $XORG_PKGS $THEMES_PKGS $ARCH_PKGS $CEREUS_BASEPKGS kde5 konsole dolphin sddm print-manager ark strawberry kate5 kcalc udisks2 okular spectacle"
        ;;
        lxqt)
            PKGS="$PKGS $XORG_PKGS $THEMES_PKGS $ARCH_PKGS $CEREUS_BASEPKGS lxqt gvfs-afc gvfs-mtp gvfs-smb udisks2 lightdm lightdm-gtk3-greeter lightdm-gtk-greeter-settings CopyQ blueman strawberry flameshot galculator-gtk3 qpdfview xed-xapps picom picom-manager pasystray-git licorice-openbox-theme-cereus qterminal-cereus-colorscheme"
        ;;
        # UNOFFICIAL EDITIONS
        fluxbox)
            PKGS="$PKGS $XORG_PKGS $THEMES_PKGS $ARCH_PKGS $CEREUS_BASEPKGS fluxbox tint2 lightdm-gtk3-greeter lightdm-gtk-greeter-settings pasystray rofi udevil xfce4-notifyd xfce4-pulseaudio-plugin ksuperkey xed-xapps audacious rxvt-unicode lxappearance qt5ct playerctl nitrogen blueman betterlockscreen clipit lxqt-policykit ksuperkey flameshot brillo skippy-xd pavucontrol nemo nemo-emblems nemo-fileroller nemo-image-converter nemo-preview nemo-python nemo-compare nemo-audio-tab galculator-gtk3 fbmenugen sierra-dark-fluxbox-theme arandr xidlehook picom picom-manager"
            ;;
        # Still incomplete
        i3wm)
            PKGS="$PKGS $XORG_PKGS $THEMES_PKGS $ARCH_PKGS $CEREUS_BASEPKGS lightdm-gtk3-greeter lightdm-gtk-greeter-settings i3-gaps"
            ;;
        lxde)
            PKGS="$PKGS $XORG_PKGS $THEMES_PKGS $ARCH_PKGS $CEREUS_BASEPKGS lxde lightdm-gtk3-greeter lightdm-gtk-greeter-settings gvfs-afc gvfs-mtp gvfs-smb udisks2"
            ;;
        *)
            >&2 echo "Unknown variant $variant"
            exit 1
        ;;
    esac

	./mklive.sh -a "$ARCH" -o $IMG -v "linux5.15" -T "Cereus Linux" -I "$CEREUS_INCLUDEDIR/${variant}" -p "$PKGS" -r "${REPO_CORE}" -r "${REPO_EXTRA}" -r "${REPO_NONFREE}" -r "${REPO_MULTILIB}" -r "${REPO_MULTILIB_NONFREE}" ${REPO} "$@"

}

if [ ! -x mklive.sh ]; then
    echo mklive.sh not found >&2
    exit 1
fi

for image in $IMAGES; do
    build_variant "$image"
done
